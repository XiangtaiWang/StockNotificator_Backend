name: Deploy to App Engine

on:
  push:
    branches:
      - main 

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Inject secrets into app.yaml
      run: |
        envsubst < Server/app.yaml > Server/app_ready.yaml
      env:
        REDIS_HOST: ${{ secrets.REDIS_HOST}}
        REDIS_TOKEN: ${{ secrets.REDIS_TOKEN}}
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        FIRESTORE_PROJECT_ID: "${{secrets.FIRESTORE_PROJECT_ID}}"
        JWT_KEY: "${{secrets.JWT_KEY}}"

    - id: 'auth'
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: 'Deploy to App Engine'
      uses: 'google-github-actions/deploy-appengine@v2'
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        deliverables: 'app_ready.yaml'
        working_directory: 'Server'
